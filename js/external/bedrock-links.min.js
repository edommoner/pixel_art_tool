const GH_API_BASE="https://api.github.com/repos/Mojang/bedrock-samples/releases?per_page=100",FALLBACK=[{ver:"latest",pageUrl:"https://github.com/Mojang/bedrock-samples/releases/latest"}];function sniffAssetUrl(assets,kind){const must=["vanilla"],any="vrp"===kind?["resource_pack","resource-pack","resource","vrp"]:["behavior_pack","behavior-pack","behavior","vbp"];for(const a of assets||[]){const n=(a.name||"").toLowerCase();if(n.endsWith(".zip")&&(must.every(k=>n.includes(k))&&any.some(k=>n.includes(k))))return a.browser_download_url}return null}function parseReleases(json,{includePre:includePre=!1}={}){const out=[];for(const rel of json){if(!includePre&&rel.prerelease)continue;const tag=rel.tag_name||rel.name||"",ver=(tag.replace(/^v/i,"")||"").trim()||(rel.name||"").trim()||"unknown",pageUrl=rel.html_url,vrp=sniffAssetUrl(rel.assets,"vrp"),vbp=sniffAssetUrl(rel.assets,"vbp");out.push({ver:ver,vrp:vrp,vbp:vbp,pageUrl:pageUrl,prerelease:!!rel.prerelease})}return out}async function fetchAllReleases({includePre:includePre=!1}={}){const headers={Accept:"application/vnd.github+json"},token=localStorage.getItem("ghToken");token&&(headers.Authorization=`Bearer ${token.trim()}`);let page=1,acc=[];for(;page<=3;){const url=`${GH_API_BASE}&page=${page}`,res=await fetch(url,{headers:headers});if(403===res.status)throw new Error("rate_limit");if(!res.ok)throw new Error("http_"+res.status);const json=await res.json();if(acc=acc.concat(json),!Array.isArray(json)||json.length<100)break;page++}return parseReleases(acc,{includePre:includePre})}export async function initBedrockLinks(){const sel=document.getElementById("bedrockVersion"),chk=document.getElementById("showPreviews"),aVRP=document.getElementById("linkBedrockVRP"),aVBP=document.getElementById("linkBedrockVBP"),aPage=document.getElementById("linkBedrockReleasePage"),status=document.getElementById("bedrockStatus");if(!(sel&&chk&&aVRP&&aVBP&&aPage))return;sel.style.minWidth="12rem",sel.innerHTML="<option>読み込み中…</option>",status&&(status.textContent="Bedrock リリースを取得中…");let list=[];async function reload(){try{list=await fetchAllReleases({includePre:chk.checked}),list.length||(list=FALLBACK.slice()),render(),status&&(status.textContent=`取得: ${list.length} リリース`)}catch(e){console.error("[bedrock-links] reload error:",e),list=FALLBACK.slice(),render(),status&&(status.textContent="rate_limit"===e.message?"GitHub API のレート制限です。数分後に再試行 or GitHubトークンを設定してください。":"取得に失敗しました。最新リリースのみ表示します。")}}function render(){sel.innerHTML=list.map((it,i)=>{const label=it.ver+(it.prerelease?" (preview)":"");return`<option value="${i}" ${0===i?"selected":""}>${label}</option>`}).join(""),apply()}function apply(){const idx=Math.max(0,parseInt(sel.value||"0",10)),item=list[idx];item&&(aVRP.href=item.vrp||item.pageUrl,aVRP.textContent=item.vrp?"Vanilla Resource Pack (.zip)":"Vanilla Resource Pack (リリースページへ)",aVBP.href=item.vbp||item.pageUrl,aVBP.textContent=item.vbp?"Vanilla Behavior Pack (.zip)":"Vanilla Behavior Pack (リリースページへ)",aPage.href=item.pageUrl)}sel.addEventListener("change",apply),chk.addEventListener("change",reload),await reload()}